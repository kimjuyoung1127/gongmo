# 영수증 OCR 기능 구현 계획 (log.md 기반)

## 1단계: 기본 UI 및 흐름 구축

### 모드 전환 기능
- [x] `scan.tsx`에 바코드/영수증 모드 전환 토글(버튼 형식) 추가
- [x] 영수증 모드 시 `useCodeScanner` 비활성화
- [x] 영수증 모드 시 동그란 셔터 버튼 표시

### 사진 촬영 및 확인 기능
- [x] `takePhoto()` 메서드로 사진 촬영 구현 (react-native-vision-camera 사용)
- [x] 사진 확인 화면 구현 (`[ 다시 찍기 ]`와 `[ 이 사진 사용 ]` 버튼)
- [x] 영수증 가이드 오버레이 추가 (한 컷에 전체 나오게, 그림자 최소화 등 안내)
- [x] **안드로이드 이미지 로드 문제 해결**: `file://` 프로토콜 추가 및 URI 처리 개선
- [ ] 이미지 리사이즈 기능 (최대 1600~2048px)
- [ ] HEIC→JPEG 변환 기능

### 기본 업로드 처리
- [ ] `/upload_receipt` API 연동
- [ ] 간단한 로딩 인디케이터 표시

## 2단계: UX 개선 및 피드백 기능

### 상세 로딩 모달
- [ ] 3단계 로딩 상태 표시:
  - [ ] "영수증 사진을 업로드하는 중..."
  - [ ] "AI가 영수증을 분석하고 있습니다..."
  - [ ] "카테고리 및 유통기한을 계산 중..."
- [ ] 각 단계별 타임아웃 설정 (10s/10s/3s)
- [ ] 재시도 기능 구현 (1회)
- [ ] 실패 시 "빠른 분석 결과만 먼저 보여드릴게요" 메시지

### 결과 검토 화면 (`receipt-review.tsx`)
- [ ] 기본 FlatList로 AI 분석 결과 표시
- [ ] 헤더에 결과 개수 표시 (예: "영수증 분석 결과 (15개)")
- [ ] 리스트 아이템 구조:
  - [ ] (좌측) 체크박스 (기본값: 체크된 상태)
  - [ ] (중앙) 품목 이름 (`clean_text`)
  - [ ] (우측) 카테고리 태그

### 체크박스 기능
- [ ] 개별 항목 체크/언체크 기능
- [ ] [전체 선택]/[전체 해제] 토글 버튼
- [ ] [선택한 N개 항목 추가] 버튼 (개수 뱃지 표시)

## 3단계: AI 피드백 및 편집 기능

### 신뢰도 기반 하이라이트
- [ ] 서버 응답의 `confidence_threshold_ui` 기준으로 하이라이트 표시 (기본값: 0.7)
- [ ] confidence 임계값 미만 항목 주황 테두리 표시
- [ ] 저신뢰 항목에 "확인 필요" 배지 추가
- [ ] 저신뢰 항목만 필터링하는 기능

### 카테고리 수정 기능
- [ ] 카테고리 태그 탭 시 바텀시트 모달 표시
- [ ] 앱 부팅/포그라운드 전환 시 `public.categories` 동기화 및 로컬 캐싱
- [ ] 바텀시트 내용:
  - [ ] 로컬 캐시된 카테고리 목록 우선 사용
  - [ ] 카테고리 검색 기능
  - [ ] 최근 사용 카테고리 5개 상단 고정
- [ ] 카테고리 변경 시 즉시 피드백 데이터 로깅

### 대량 편집 기능
- [ ] 복수 선택 상태 표시
- [ ] 선택된 항목들 일괄 카테고리 변경 기능
- [ ] 상단 툴바에 일괄 변경 액션 버튼

## 4단계: 데이터 처리 및 저장

### 품목 데이터 정제
- [ ] 금액/합계/쿠폰/카드번호 패턴 필터링
- [ ] 중복 품목 병합 및 수량 합산
- [ ] "1+1", "x2", "2개/봉" 등 수량 추론 기능

### 재고 저장 기능
- [ ] 체크된 항목들만 `inventory` 테이블에 저장
- [ ] `receipt_item_id` 연결 저장
- [ ] 토스트 메시지로 "재고에 추가되었습니다!" 표시
- [ ] 저장 완료 시 재고 탭(`index.tsx`)으로 자동 이동
- [ ] 방금 추가한 항목 하이라이트 및 스크롤 포커스

## 4.5단계: 바코드 캐싱 시스템 완료 (✅ 2025-11-15 완료)

### DB 캐싱 구조 완성
- [x] **products 테이블 연동**: 사용자 직접 입력 데이터를 products 테이블에 자동 저장
- [x] **2단계 저장**: products → inventory 테이블 순서로 저장하여 앱 전체 데이터 향상
- [x] **카테고리 연동**: 카테고리 이름으로 categories 테이블의 ID 조회 및 연동
- [x] **DB HIT/MISS 로깅**: 백엔드에서 캐시 히트 여부 명확히 표시
- [x] **API 호출 최적화**: 캐시된 바코드는 외부 API 호출 없이 즉시 응답

### 직접 입력 기능 완료
- [x] **404 오류 처리**: 바코드를 찾지 못했을 때 직접 입력 화면 표시
- [x] **상세 입력 폼**: 상품 이름, 카테고리, 유통기한 입력 기능
- [x] **유효성 검사**: 필수 필드 입력 확인 및 에러 처리
- [x] **알림 개선**: 저장 성공 시 다른 사용자와 공유된다는 메시지 포함

### 시스템 효과
- **정확도 향상**: 사용자들이 직접 입력한 데이터가 모든 사용자에게 공유됨
- **속도 개선**: 한 번 찾은 바코드는 0.1초 내에 응답
- **안정성**: 외부 API 실패 시에도 캐시된 데이터로 계속 서비스 제공
- **점진적 개선**: 사용자들이 많아질수록 데이터베이스가 풍부해져 정확도 향상

## 5단계: MLOps 및 고급 기능

### 피드백 데이터 수집
- [ ] 사용자 카테고리 수정 시 `user_category_feedback` 테이블에 즉시 저장
- [ ] 원본 예측/신뢰도/수정값/receipt_item_id 저장
- [ ] 일단위 집계 리포트 기능 (저신뢰→실제 수정율)

### 하이브리드 OCR (추후 구현)
- [ ] 온디바이스 OCR(ML Kit)로 빠른 1차 파싱
- [ ] 백그라운드로 서버 PaddleOCR 동시 실행
- [ ] 정확도 높은 2차 결과 도착 시 자동 업데이트
- [ ] "더 정확한 분석 결과를 반영했어요" 토스트 표시

## 백엔드 연동 요청사항

### API 수정 필요
- [ ] `/upload_receipt` 응답 형식 수정:
  ```json
  {
    "receipt_id": 123,
    "image_url": "...",
    "items": [
      {
        "id": 456,
        "raw_text": "상추 2봉",
        "clean_text": "상추",
        "pred": { 
          "category_id": 8, 
          "category_code": "leafy_veg", 
          "confidence": 0.82 
        },
        "expiry_days": 3,
        "quantity_hint": 2,
        "warnings": ["MULTI_QUANTITY_DETECTED"]
      }
    ],
    "stats": { 
      "latency_ms": 5120, 
      "engine": "paddleocr+rules+clf_v2" 
    }
  }
  ```

### 신규 API 필요
- [ ] `/inventory/batch_add` API 구현
- [ ] 요청 형식:
  ```json
  {
    "items": [
      {
        "receipt_item_id": 456,
        "name": "상추",
        "category_id": 8,
        "quantity": 2,
        "purchase_date": "2025-11-15",
        "expiry_date": "2025-11-18",
        "idempotency_key": "uuid-string"
      }
    ]
  }
  ```

### DB 테이블 필요
- [ ] `user_category_feedback` 테이블 생성
- [ ] 필드: receipt_item_id, original_category_id, user_category_id, confidence, created_at

## 기타 고려사항

### 인증 처리
- [ ] 모든 API 호출에 Supabase JWT 헤더 포함
- [ ] 토큰 만료 시 재로그인 유도

### 오류 처리
- [ ] 400(형식), 401(토큰), 413(용량), 422(OCR실패), 500(서버) 오류코드 처리
- [ ] 로컬 사전으로 오류코드 → 사용자 문구 매핑 (예: 422: "문자 인식이 어려웠어요. 밝은 곳에서 다시 촬영해 주세요")
- [ ] 일관된 오류 메시지 표시

### 로깅
- [ ] API 호출 로깅 (latency_ms, 엔진 버전, 규칙 히트 여부)
- [ ] 사용자 액션 로깅 (카테고리 수정, 항목 선택 등)

## 추가 고려사항 (최신 log.md 및 실제 구현 기반)

### ✅ 해결된 이슈 (2025-11-15)
- [x] **안드로이드 이미지 로딩**: 촬영 후 `file://` 프로토콜 추가로 이미지 로드 문제 해결
- [x] **카메라 디바이스 설정**: 후면 카메라(`'back'`) 명시적 지정 확인
- [x] **모듈화 진행**: scan.tsx에서 PhotoConfirmModal.tsx로 컴포넌트 분리
- [x] **로그 기능**: `[PHOTO-1]~[PHOTO-3]` 로그 포맷으로 촬영 프로세스 추적 가능

### 현재 로그 확인 결과
```
LOG  [PHOTO-1] 사진 촬영 결과: {"height": 3060, ...}
LOG  [PHOTO-2] 촬영된 이미지 URI: /data/user/0/...
LOG  [PHOTO-2-1] 최종 이미지 URI: file:///data/user/0/...  ✅ 추가됨
LOG  [PHOTO-3] 사진 확인 화면 표시
```

### 수량 힌트 활용
- [ ] API 응답의 `quantity_hint` 필드로 체크박스 기본 수량 프리셋 설정
- [ ] 수량 추론("2봉/1+1/x2")은 서버에서 처리, 프론트는 힌트만 사용

### 이슈 진단 및 해결 방법론
- [x] **로그 기반 진단**: 실제 로그와 log.md 내용 비교로 진실성 확인
- [x] **단계적 해결**: import 오류 → 데이터 구조 → useEffect → DB 저장 순서로 수정
- [ ] **플랫폼별 처리**: iOS/Android 파일 시스템 차이에 따른 URI 처리 강화

### 이미지 저장 및 추적성
- [ ] `/upload_receipt` 응답에 항상 `image_url` 포함하도록 백엔드 요청
- [ ] Supabase Storage 'ocr' 버킷에 이미지 저장 확인

### DB 스키마 확장
- [x] `inventory` 테이블의 `quantity`/`barcode`/`status`/`purchase_date`/`expiry_date` 필드 활용
- [x] 해당 필드들의 유통기한 계산 및 Supabase 일괄 삽입 로직 구현 완료
