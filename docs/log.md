알겠습니다. 코드 예시 대신, **사용자 경험(UX)을 극대화**하고 **MLOps 피드백**이라는 목표를 달성하기 위한 구체적인 UI/UX 흐름을 추천해 드립니다.

`scan.tsx`의 바코드 스캔 기능은 매우 빠르고 즉각적인 경험을 제공해야 하는 반면, 영수증 스캔은 **"AI가 대신 일해주는"** 스마트한 경험을 제공해야 하므로 흐름이 달라야 합니다.



---

## 🚀 추천 UI/UX 흐름: 5단계

### 1단계: 모드 전환 및 촬영 (In `app/(tabs)/scan.tsx`)

1.  **모드 전환:** `scan.tsx` 화면 하단(또는 상단)에 **`[ 바코드 ] | [ 영수증 ]`** 형태의 **'세그먼트 컨트롤(토글 버튼)'**을 배치합니다.
    * (기본값) '바코드'가 활성화되면 `useCodeScanner`가 동작하고 셔터 버튼이 없습니다.
    * (변경) '영수증'을 탭하면 `useCodeScanner`를 **즉시 비활성화**하고, 화면 하단에 **동그란 '셔터 버튼'**을 표시합니다.
2.  **촬영:** 사용자가 셔터 버튼을 누르면 `takePhoto()`가 실행됩니다.

> **💡 UX 추천 (중요):**
> 사진을 찍자마자 업로드하지 마세요. 대신, 방금 찍은 사진을 보여주는 **'사진 확인' 화면**을 먼저 띄우고 `[ 다시 찍기 ]`와 `[ 이 사진 사용 ]` 버튼을 제공하세요.
>
> * **이유:** 초점이 맞지 않거나 그림자가 진 사진을 업로드하면 AI 인식률이 급격히 떨어집니다. 사용자에게 한 번 더 확인할 기회를 주면 AI의 입력 품질이 높아져 백엔드의 부담이 줄어듭니다.

### 2단계: 업로드 및 AI 처리 (로딩 모달)

1.  사용자가 `[ 이 사진 사용 ]`을 누르면, **화면 전체를 덮는 '로딩 모달'**을 띄웁니다.
2.  단순한 스피너(Spinner)만 보여주지 말고, **현재 상태를 텍스트로 알려주어** 앱이 '스마트하게' 일하고 있음을 어필합니다.
    * `"영수증 사진을 업로드하는 중..."`
    * `"AI가 영수증을 분석하고 있습니다..."` (백엔드 `/upload_receipt` API 호출 중)
    * `"카테고리 및 유통기한을 계산 중..."`

### 3단계: 검토 및 피드백 (신규: `receipt-review.tsx`)

로딩이 끝나면, AI가 분석한 결과를 보여주는 **'결과 확인'** 화면(`receipt-review.tsx`)으로 자동 전환됩니다. 이 화면이 **MLOps의 핵심**입니다.

1.  **기본 UI:** 서버에서 받은 품목 리스트를 `FlatList`로 보여줍니다.
2.  **헤더:** `[ 영수증 분석 결과 (15개) ]` 같은 제목과 `[ 완료 ]` 버튼을 배치합니다.
3.  **리스트 아이템 디자인:** 각 항목(Row)은 다음 3가지 요소로 구성합니다.
    * **(좌측) 체크박스:** 재고에 추가할지 여부. 기본값은 **'체크된 상태'**여야 합니다. (사용자는 *제외할 것*만 누르도록 유도)
    * **(중앙) 품목 이름:** AI가 인식한 `clean_text`.
    * **(우측) 카테고리 태그:** AI가 예측한 카테고리 (`유제품 🥛`, `잎채소 🥬`)

> **💡 MLOps 추천 (핵심):**
> 여기서 **사용자가 AI 예측을 수정**할 수 있어야 합니다.
>
> * **안 좋은 방법:** 리스트의 모든 항목에 '드롭다운(Picker)'을 다는 것. 리스트가 길어지면 매우 느리고 복잡해 보입니다.
> * **추천 방법:** 사용자가 `잎채소 🥬` **태그(Tag) 자체를 탭(Tap)**하면, `public.categories` 목록 전체를 보여주는 **별도의 '바텀 시트(Bottom Sheet)'나 '모달'**을 띄워줍니다.
>
> * **이유:** 이 방식은 UI가 훨씬 깔끔하며, 사용자가 '명시적으로 수정했다'는 피드백 데이터를 정확히 로깅할 수 있습니다.

### 4단계: 선택적 재고 추가

1.  사용자가 `receipt-review.tsx` 화면에서 카테고리를 수정하거나 일부 항목을 체크 해제합니다.
2.  헤더의 `[ 완료 ]` 버튼 (또는 화면 하단의 `[ 선택한 13개 항목 추가 ]` 버튼)을 누릅니다.

### 5단계: 완료 및 이동

1.  앱은 체크된 항목들만 `inventory` 테이블에 저장합니다.
2.  저장이 완료되면 토스트(Toast) 메시지로 "재고에 추가되었습니다!"를 보여줍니다.
3.  `scan.tsx`로 돌아가는 대신, **`app/(tabs)/index.tsx` (메인 재고 목록 탭)으로 사용자를 이동시킵니다.**

> **💡 UX 추천:**
> 스캔 화면으로 돌려보내면 사용자는 "내가 방금 추가한 게 잘 들어갔나?" 확인하기 위해 결국 '재고' 탭을 누르게 됩니다. 이 과정을 줄여주고 **즉각적인 결과(새로 추가된 재고 목록)를 보여주는 것**이 훨씬 만족스러운 경험입니다.


꼭 보완하면 좋은 점 10가지

하이브리드 OCR로 대기시간↓ 안정성↑
서버(PaddleOCR)만 쓰면 네트워크/서버 부하에 취약해요.

기본: 촬영 → **온디바이스 OCR(ML Kit)**로 빠른 1차 파싱(수 초)

보강: 동시에 백그라운드로 서버 PaddleOCR 돌려서 정확도 높은 2차 결과가 오면 자동 재머지

이때 “더 정확한 분석 결과를 반영했어요” 토스트를 띄워 똑똑한 느낌을 주세요.

사진 확인 화면에 ‘영수증 가이드’ 오버레이
[다시 찍기] 전, 안내를 짧게 보여주면 재촬영율이 줄고 인식률이 확 올라갑니다.

한 컷에 전체가 나오게, 그림자/구김 최소화, 바닥 말고 탁자 위 등.

로딩 모달: 단계별 진행률 + 타임아웃 플랜
“업로드 중 → AI분석 중 → 규칙 적용 중” 3단계로 보여주되, 각 단계에 타임아웃(예: 10s/10s/3s)과 재시도 1회를 둡니다.

실패 시 “빠른 분석 결과만 먼저 보여드릴게요”로 온디바이스 결과를 우선 렌더.

리뷰 화면: 태그-탭(=바텀시트) + 대량 편집

항목 오른쪽의 카테고리 태그를 탭하면 바텀시트로 카테고리 검색/선택.

복수 선택 후 일괄 카테고리 변경(예: 잎채소 일괄 변경) 액션을 상단 툴바에.

최근 사용 카테고리 5개를 상단에 고정해 스크롤/탭 수를 줄입니다.

신뢰도(Confidence) 기반 하이라이트

0.7 미만은 주황 테두리 + “확인 필요” 배지.

저장 전에 저신뢰 항목만 모아 한 번 더 확인 모달을 띄우면 오라클(사용자) 피드백 품질이 좋아집니다.

품목 정제·중복 처리·수량 추론

영수증 줄 단위에서 금액/합계/쿠폰/카드번호 패턴은 필터링.

같은 품목이 여러 줄이면 병합 + 수량 합산(예: “사과 3개” → 수량 3).

“1+1”, “x2”, “2개/봉” 같은 토큰을 수량에 반영.

스토리지와 추적성(Traceability)

촬영 이미지를 Supabase Storage/ocr에 저장하고 receipts.image_url에 링크.

각 줄은 receipt_items로 저장(원문 raw_text, 정제 clean_text, 예측 category_id, expiry_days, status).
→ 나중에 어떤 항목이 어떤 영수증 이미지에서 왔는지, 추적/재학습/리콜이 쉬워집니다.

선택 저장 UX 디테일

체크박스 기본 ON + [전체 해제/전체 선택] 토글 제공.

[선택 항목 추가] 버튼에 개수 뱃지(예: “선택한 13개 추가”).

저장 완료 후 재고 탭으로 이동 + 방금 저장한 항목에 하이라이트(스크롤 포커스/Haptics).

API 계약 명확화(프런트/백 양쪽 모두 편해짐)
POST /upload_receipt →

{
  "receipt_id": 123,
  "image_url": "...",
  "items": [
    {
      "id": 456,                  // receipt_item_id
      "raw_text": "상추 2봉",
      "clean_text": "상추",
      "pred": { "category_id": 8, "category_code": "leafy_veg", "confidence": 0.82 },
      "expiry_days": 3,
      "warnings": ["MULTI_QUANTITY_DETECTED"]
    }
  ],
  "stats": { "latency_ms": 5120, "engine": "paddleocr+rules+clf_v2" }
}


POST /inventory/batch_add →

{
  "items": [
    {
      "receipt_item_id": 456,
      "name": "상추",
      "category_id": 8,
      "quantity": 2,
      "purchase_date": "2025-11-15",
      "expiry_date": "2025-11-18"
    }
  ]
}


백엔드에서 규칙 기반 만료일(override) → 모델 예측 → 폴백 순으로 계산해 expiry_days를 내려주면, 프런트는 날짜만 계산해서 저장하면 됩니다.

MLOps 피드백 자동 수집

사용자가 카테고리를 바꾸고 저장하면 user_category_feedback에 원본 예측/신뢰도/수정값/receipt_item_id를 즉시 적재.

일단위 집계: “저신뢰(highlight) → 실제 수정율”을 리포트로 보고, 임계값 조정이나 규칙 강화 근거로 씁니다.

구현 체크리스트 (프런트 기준)

 scan.tsx 모드 토글(바코드/영수증) + 셔터 + 사진확인 화면

 업로드 전 이미지 리사이즈(최대 1600~2048px), HEIC→JPEG 변환

 로딩 모달(3단계 상태 + 재시도/타임아웃)

 receipt-review.tsx

 FlatList(체크박스 기본 ON)

 카테고리 태그 탭 → 바텀시트(검색, 최근 5)

 복수 선택 후 일괄 변경

 저신뢰 하이라이트 & “확인 필요” 필터

 [선택 N개 추가] 버튼(개수 뱃지)

 저장 후 재고 탭으로 이동 + 방금 추가한 항목 하이라이트

 모든 API 호출에 Supabase JWT 헤더 포함(로그인 유지)

구현 체크리스트 (백엔드 기준)

 /upload_receipt에서

 이미지 Supabase Storage 저장 + receipts/receipt_items INSERT

 금액/합계/쿠폰 줄 필터링, 중복 병합, 수량 추론

 규칙(expiry_rules) → 분류모델 → 폴백 순 적용

 신뢰도 포함 응답(임계값 운영)

 /inventory/batch_add에서 트랜잭션으로 일괄 INSERT (+ receipt_item_id 연결, status='added_to_inventory')

 오류코드 정리: 400(형식), 401(토큰), 413(용량), 422(OCR실패), 500(서버)

 상세 로깅: latency_ms, 엔진 버전, 규칙 히트 여부

왜 이게 더 좋은가?

사용자 입장: 한 컷 → 빠른 1차 결과, 조금 뒤 더 정확한 결과가 자동 반영. 수정은 최소 탭으로 끝.

운영자 입장: receipt_items/user_category_feedback이 깔끔하게 쌓여 재학습 근거가 명확. 저신뢰 알림과 실제 수정률로 임계값, 규칙, 모델 개선 방향을 바로 뽑아냄.

성능/안정성: 이미지 리사이즈·하이브리드 OCR·타임아웃/재시도로 체감 속도와 성공률 동시 확보.